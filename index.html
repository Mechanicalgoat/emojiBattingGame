<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>絵文字バッティングゲーム</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <h1>⚾ 絵文字バッティングゲーム ⚾</h1>
            <div class="score-board">
                <span>残り: <span id="balls-left">10</span>球</span>
                <span>ホームラン: <span id="home-run-count">0/3</span>本</span>
            </div>
        </div>
        
        <div class="game-field">
            <!-- スタジアム背景 -->
            <div class="stadium-background"></div>
            
            <!-- 3D要素のコンテナ -->
            <div class="field-ground"></div>
            <div class="stands"></div>
            <div class="infield"></div>
            <div class="pitcher-mound"></div>
            
            <!-- スコアボード -->
            <div class="scoreboard">
                <div class="scoreboard-display">NPB</div>
            </div>
            
            <!-- ベース -->
            <div class="home-plate">⬜</div>
            <div class="first-base">⬜</div>
            <div class="second-base">⬜</div>
            <div class="third-base">⬜</div>
            
            <!-- ピッチャーとバッター -->
            <div class="pitcher">🧍</div>
            <div class="batter-box"></div>
            <div class="batter" id="batter">🏏</div>
            
            <!-- バッターの情報表示 -->
            <div class="player-info player-info-left">
                <div class="player-name">P プレイヤー様</div>
                <div class="player-stats">盛岡 左打 左投 二塁手</div>
            </div>
            
            <!-- ピッチャーの情報表示 -->
            <div class="player-info player-info-right">
                <div class="player-name">P コンピュータ</div>
                <div class="player-stats">球速: 145km/h</div>
            </div>
            
            <!-- ボールと打撃ゾーン -->
            <div id="ball" class="ball">⚾</div>
            <div id="strike-zone" class="strike-zone">
                <div class="zone-text">ここでバットを振る</div>
            </div>
            
            <!-- 飛距離メーター -->
            <div class="distance-meter">
                <span id="distance-value">0</span>m
            </div>
            
            <!-- フィールド俯瞰図 (ホームラン時に表示) -->
            <div class="field-overview">
                <h2>ホームラン！</h2>
                <div class="field-map">
                    <div class="field-map-home">⬜</div>
                    <div id="ball-landing" class="ball-landing"></div>
                </div>
                <p>飛距離: <span id="overview-distance">0</span>m</p>
                <button class="close-overview">閉じる</button>
            </div>
        </div>
        
        <div class="game-controls">
            <button id="start-button">ゲームスタート</button>
            <div id="result-message" class="result-message"></div>
        </div>
    </div>

    <script>
    // 直接スクリプトを埋め込んで確実に実行されるようにする
    document.addEventListener('DOMContentLoaded', () => {
        // 難易度設定
        window.difficultySettings = {
            easy: {
                ballSpeed: 2000,
                strikeZoneSize: 1.2,
                hitWindow: 600,
                requiredHomeRuns: 2,
                pitcherEmoji: '🧍'
            },
            normal: {
                ballSpeed: 1500,
                strikeZoneSize: 1.0,
                hitWindow: 400,
                requiredHomeRuns: 3,
                pitcherEmoji: '🧍‍♂️'
            },
            hard: {
                ballSpeed: 1000,
                strikeZoneSize: 0.8,
                hitWindow: 200,
                requiredHomeRuns: 5,
                pitcherEmoji: '🏃‍♂️'
            }
        };

        // 現在の難易度
        window.currentDifficulty = 'normal';
        
        // ゲーム要素を取得
        const startButton = document.getElementById('start-button');
        const ballsLeftElement = document.getElementById('balls-left');
        const homeRunCountElement = document.getElementById('home-run-count');
        const resultMessageElement = document.getElementById('result-message');
        const ball = document.getElementById('ball');
        const strikeZone = document.getElementById('strike-zone');
        const batter = document.getElementById('batter');
        const pitcher = document.querySelector('.pitcher');
        const gameField = document.querySelector('.game-field');
        const distanceMeter = document.querySelector('.distance-meter');
        const distanceValue = document.getElementById('distance-value');
        const fieldOverview = document.querySelector('.field-overview');
        const ballLanding = document.getElementById('ball-landing');
        const overviewDistance = document.getElementById('overview-distance');
        const closeOverviewButton = document.querySelector('.close-overview');
        const scoreboard = document.querySelector('.scoreboard-display');

        // ゲーム変数
        let ballsLeft = 10;
        let homeRunCount = 0;
        let isGameActive = false;
        let canSwing = false;
        let currentBallPosition = { x: 0, y: 0, z: 0 };
        let ballTrajectory = [];
        
        // 現在の難易度に基づく設定
        const settings = window.difficultySettings[window.currentDifficulty];
        
        // フィールドのサイズを取得 (スケーリング用)
        const fieldRect = gameField.getBoundingClientRect();
        const fieldWidth = fieldRect.width;
        const fieldHeight = fieldRect.height;

        // スタートボタンのイベントリスナー
        startButton.addEventListener('click', startGame);

        // ストライクゾーンのマウスイベント
        strikeZone.addEventListener('mousemove', (e) => {
            if (isGameActive) {
                // マウス位置にバットを移動
                const rect = strikeZone.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                batter.style.left = `${e.clientX - gameField.getBoundingClientRect().left}px`;
                batter.style.bottom = '110px'; // 高さは固定
                batter.style.transform = 'translateX(-50%)';
            }
        });

        strikeZone.addEventListener('click', (e) => {
            if (isGameActive && canSwing) {
                swing(e);
            }
        });
        
        // 俯瞰図を閉じるボタン
        if (closeOverviewButton) {
            closeOverviewButton.addEventListener('click', () => {
                fieldOverview.style.display = 'none';
                // 次の投球へ
                setTimeout(throwBall, 500);
            });
        }

        // ゲーム開始関数
        function startGame() {
            console.log("ゲーム開始!");
            if (isGameActive) return;

            // ゲーム変数のリセット
            ballsLeft = 10;
            homeRunCount = 0;
            isGameActive = true;
            updateUI();

            startButton.textContent = 'ゲーム中...';
            startButton.disabled = true;
            if (resultMessageElement) resultMessageElement.textContent = '';
            if (fieldOverview) fieldOverview.style.display = 'none';
            
            // スコアボード更新
            updateScoreboard('PLAY BALL!');

            // バットの初期位置
            batter.style.position = 'absolute';
            batter.style.bottom = '110px';
            batter.style.left = '50%';
            batter.style.transform = 'translateX(-50%)';

            // 最初の投球を開始
            throwBall();
        }

        // スコアボード更新
        function updateScoreboard(text) {
            if (scoreboard) {
                scoreboard.textContent = text;
            }
        }

        // 投球関数
        function throwBall() {
            if (ballsLeft <= 0) {
                endGame();
                return;
            }

            // ボールを初期位置に設定（ピッチャーポジション）
            ball.style.left = '50%';
            ball.style.bottom = '250px';
            ball.style.transform = 'translate(-50%, -50%) scale(0.8)';
            ball.style.visibility = 'visible';
            ball.style.transition = 'none';
            ball.style.zIndex = '15';
            
            // トラッキング用の初期位置
            currentBallPosition = { x: fieldWidth/2, y: 250, z: 0 };
            ballTrajectory = [{ ...currentBallPosition }];
            
            // クラスをリセット
            ball.classList.remove('home-run');
            ball.classList.remove('ball-through');
            
            // 飛距離メーターを非表示
            if (distanceMeter) distanceMeter.style.display = 'none';
            
            // ピッチャーのモーション
            pitcher.textContent = '🤾';
            
            setTimeout(() => {
                // 難易度に応じたピッチャー絵文字を使用
                pitcher.textContent = settings.pitcherEmoji;
                
                // ストライクゾーン内のランダムな位置を計算
                const zoneRect = strikeZone.getBoundingClientRect();
                const fieldRect = gameField.getBoundingClientRect();
                
                // ターゲット位置を計算（ストライクゾーンの中心から少しランダムにずらす）
                const zoneCenterX = zoneRect.left + zoneRect.width / 2 - fieldRect.left;
                const zoneCenterY = fieldRect.bottom - zoneRect.top - zoneRect.height / 2;
                
                const randomOffsetX = (Math.random() - 0.5) * zoneRect.width * 0.8;
                const randomOffsetY = (Math.random() - 0.5) * zoneRect.height * 0.8;
                
                const targetX = zoneCenterX + randomOffsetX;
                const targetY = zoneCenterY + randomOffsetY;
                
                // 3D的な投球アニメーションのための中間点
                const midpointY = (parseFloat(ball.style.bottom) + targetY) / 2;
                const midpointZ = 30; // ボールが最も手前に来る位置
                
                // ボールを投げる
                setTimeout(() => {
                    // ステップ1: 中間点へ（ボールが近づいてくる）
                    ball.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.6, 1)';
                    ball.style.left = `${targetX}px`;
                    ball.style.bottom = `${midpointY}px`;
                    ball.style.transform = 'translate(-50%, -50%) scale(1.2)';
                    
                    // トラッキング中間点
                    setTimeout(() => {
                        currentBallPosition = { x: targetX, y: midpointY, z: midpointZ };
                        ballTrajectory.push({ ...currentBallPosition });
                        
                        // ステップ2: 目標点へ（ストライクゾーン）
                        ball.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.6, 1)';
                        ball.style.bottom = `${targetY}px`;
                        ball.style.transform = 'translate(-50%, -50%) scale(1)';
                        
                        canSwing = true;
                        
                        // スイングしなかった場合（見逃し）
                        setTimeout(() => {
                            if (canSwing) {
                                canSwing = false;
                                ballsLeft--;
                                updateUI();
                                if (resultMessageElement) resultMessageElement.textContent = '見逃し！';
                                
                                // スコアボード更新
                                updateScoreboard('BALL!');
                                
                                // ボールを通過させる
                                ball.style.transition = 'all 0.4s ease-in';
                                ball.style.bottom = '-50px';
                                
                                currentBallPosition = { x: targetX, y: -50, z: -30 };
                                ballTrajectory.push({ ...currentBallPosition });
                                
                                // 次の投球
                                setTimeout(throwBall, 1000);
                            }
                        }, settings.hitWindow * 1.5); // 難易度に応じた待機時間
                    }, settings.ballSpeed * 0.25);
                }, 200);
            }, 300);
        }

        // スイング関数
        function swing(e) {
            if (!canSwing) return;
            
            canSwing = false;
            ballsLeft--;

            // バットをスイング
            batter.classList.add('swing');
            setTimeout(() => {
                batter.classList.remove('swing');
            }, 300);

            // ヒットエフェクト
            createHitEffect(e.clientX, e.clientY);

            // ボールとの衝突判定
            const ballRect = ball.getBoundingClientRect();
            const batterRect = batter.getBoundingClientRect();
            
            const ballCenterX = ballRect.left + ballRect.width/2;
            const ballCenterY = ballRect.top + ballRect.height/2;
            
            const batterCenterX = batterRect.left + batterRect.width/2;
            const batterCenterY = batterRect.top + batterRect.height/2;
            
            const distance = Math.sqrt(
                Math.pow(ballCenterX - batterCenterX, 2) + 
                Math.pow(ballCenterY - batterCenterY, 2)
            );

            // 難易度に基づくヒット判定の距離
            const hitDistance = 70 * settings.hitWindow / 400;

            if (distance < hitDistance) { // 難易度に応じたヒット判定
                // ホームラン！
                homeRunCount++;
                const homeRunDistance = calculateHomeRunDistance();
                
                // 飛距離メーターを表示
                if (distanceMeter) {
                    distanceMeter.style.display = 'block';
                    distanceValue.textContent = homeRunDistance;
                }
                
                // スコアボード更新
                updateScoreboard('HOME RUN!');
                
                // ホームラン軌道のアニメーション
                animateHomeRun(homeRunDistance);
                
                if (resultMessageElement) resultMessageElement.textContent = `ホームラン！ ${homeRunDistance}m飛んだ！`;
            } else {
                // 空振り
                if (resultMessageElement) resultMessageElement.textContent = '空振り！';
                
                // スコアボード更新
                updateScoreboard('STRIKE!');
                
                // ボールを通過させる
                ball.style.transition = 'all 0.4s ease-in';
                ball.style.bottom = '-50px';
                
                // 次の投球
                setTimeout(throwBall, 1200);
            }

            updateUI();
        }
        
        // ホームランアニメーション
        function animateHomeRun(distance) {
            // 軌道に応じた角度と距離を計算
            const angle = Math.random() * 60 - 30; // -30度から30度のランダムな角度
            const angleRad = angle * Math.PI / 180;
            
            // ボールの飛距離に応じた位置を計算
            const normalizedDistance = Math.min(distance / 150, 1); // 150mを最大とする
            
            // 初速と角度からの放物線軌道
            const animateStep = (progress) => {
                // 放物線の式: y = x - x²
                const x = progress;
                const y = x - Math.pow(x/1.5, 2);
                
                // x成分の計算（角度を考慮）
                const xOffset = normalizedDistance * 300 * Math.sin(angleRad) * progress;
                const xPos = fieldWidth/2 + xOffset;
                
                // y成分の計算（放物線）
                const yPos = 110 + y * 300;
                
                // スケール（遠近感）
                const scale = Math.max(0.1, 1 - progress * 0.9);
                
                // ボールの位置を更新
                ball.style.transition = 'none';
                ball.style.left = `${xPos}px`;
                ball.style.bottom = `${yPos}px`;
                ball.style.transform = `translate(-50%, -50%) scale(${scale})`;
                
                // 現在のボール位置を記録（トラッキング用）
                currentBallPosition = { x: xPos, y: yPos, z: -(progress * 100) };
                ballTrajectory.push({ ...currentBallPosition });
                
                if (progress < 1) {
                    requestAnimationFrame(() => animateStep(progress + 0.04));
                } else {
                    // アニメーション完了時
                    ball.style.visibility = 'hidden';
                    
                    // 俯瞰図を表示（存在する場合）
                    if (fieldOverview && ballLanding && overviewDistance) {
                        fieldOverview.style.display = 'flex';
                        
                        // ランディング地点の表示（角度と距離から計算）
                        const landingX = 150 + Math.sin(angleRad) * normalizedDistance * 120;
                        const landingY = 50 + normalizedDistance * 200;
                        
                        ballLanding.style.left = `${landingX}px`;
                        ballLanding.style.top = `${landingY}px`;
                        
                        overviewDistance.textContent = distance;
                    } else {
                        // 俯瞰図がない場合は次の投球へ
                        setTimeout(throwBall, 1500);
                    }
                }
            };
            
            // アニメーション開始
            animateStep(0);
        }

        // ホームラン距離の計算
        function calculateHomeRunDistance() {
            // 難易度と乱数を組み合わせて飛距離を計算
            const basePower = Math.random() * 70 + 80; // 80〜150mのベース飛距離
            // 難しいほど飛距離が出る確率が高い（上級者向け）
            const difficultyBonus = (window.currentDifficulty === 'hard') ? 20 : 
                                   (window.currentDifficulty === 'easy') ? -10 : 0;
            
            return Math.floor(basePower + difficultyBonus);
        }

        // ヒットエフェクトの作成
        function createHitEffect(x, y) {
            const effect = document.createElement('div');
            effect.className = 'hit-effect';
            effect.textContent = '💥';
            effect.style.left = `${x}px`;
            effect.style.top = `${y}px`;
            gameField.appendChild(effect);
            
            // エフェクトを一定時間後に削除
            setTimeout(() => {
                if (effect.parentNode === gameField) {
                    gameField.removeChild(effect);
                }
            }, 500);
        }

        // UI更新関数
        function updateUI() {
            // 必要なホームラン数（難易度による）
            const requiredHomeRuns = settings.requiredHomeRuns || 3;
            
            if (ballsLeftElement) ballsLeftElement.textContent = ballsLeft;
            if (homeRunCountElement) homeRunCountElement.textContent = `${homeRunCount}/${requiredHomeRuns}`;
        }

        // ゲーム終了処理
        function endGame() {
            isGameActive = false;
            startButton.disabled = false;
            startButton.textContent = 'もう一度プレイ';
            
            // 必要なホームラン数（難易度による）
            const requiredHomeRuns = settings.requiredHomeRuns || 3;
            
            // スコアボード更新
            if (homeRunCount >= requiredHomeRuns) {
                updateScoreboard('GAME CLEAR!');
            } else {
                updateScoreboard('GAME OVER');
            }
            
            // 結果メッセージ
            if (resultMessageElement) {
                if (homeRunCount >= requiredHomeRuns) {
                    resultMessageElement.textContent = `クリア！ ${homeRunCount}本のホームランを打ちました！`;
                    resultMessageElement.style.color = '#4caf50';
                } else {
                    resultMessageElement.textContent = `残念！ クリアには${requiredHomeRuns}本必要です（${homeRunCount}本）`;
                    resultMessageElement.style.color = '#f44336';
                }
            }
        }
        
        // 初期UI更新
        updateUI();
    });
    </script>
</body>
</html>
